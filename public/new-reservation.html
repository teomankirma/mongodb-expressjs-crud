<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Reservation</title>
  <script>
    let ticketTypesData = [];

    window.onload = function () {
      // Set the min attribute of the date input field to the current date
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth() + 1;

      document.getElementById('date').setAttribute('min', today);


      document.getElementById("expiry-year").setAttribute("min", currentYear)

      const expiryYearInput = document.getElementById("expiry-year");
      const expiryMonthInput = document.getElementById("expiry-month");

      expiryYearInput.addEventListener("change", validateExpiryDate);
      expiryMonthInput.addEventListener("change", validateExpiryDate);

      function validateExpiryDate() {
        if (parseInt(expiryYearInput.value, 10) === currentYear) {
          expiryMonthInput.setAttribute("min", currentMonth);
        }
      }


      const user = JSON.parse(localStorage.getItem('user'));

      if (!user)
        window.location.href = "/signin"; // Redirect to signin page if user doesn't exists

      // Get the select element
      const select = document.getElementById('ticket-type');

      // Fetch ticket types from the server
      fetch('/ticket-types')
        .then(response => response.json())
        .then(ticketTypes => {
          ticketTypesData = ticketTypes;

          // For each ticket type
          ticketTypes.forEach(ticketType => {
            // Create a new option element
            const option = document.createElement('option');

            option.id = ticketType._id;
            option.value = ticketType.type;
            option.textContent = ticketType.type;

            select.appendChild(option);
          });
        })
        .catch(error => console.error('Error:', error));

      // Get the form element
      const form = document.getElementById('newReservationForm');

      // Add an event listener to the form
      form.addEventListener('submit', function (event) {
        // Prevent the default form submission behavior
        event.preventDefault();

        // Get the form data
        const ticketType = document.getElementById('ticket-type').value;
        const date = document.getElementById('date').value;
        const people = document.getElementById('people').value;
        const priceText = document.getElementById('price').textContent;
        const price = priceText ? parseFloat(priceText.replace('Price: $', '')) : 0;

        // Create the request body
        const body = {
          userId: user._id,
          ticketType,
          date,
          people,
          price
        };

        // Send a POST request to the server
        fetch('/new-reservation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(body),
        })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              alert(data.error);
            } else {

              // Update the user object in localStorage
              user.reservations.push({ ticketType, date, people, price, _id: data._id });
              localStorage.setItem('user', JSON.stringify(user));

              alert('Reservation added successfully');
              window.location.href = '/dashboard'; // Redirect to dashboard page
            }
          })
          .catch((error) => {
            console.error('Error:', error);
          });
      });

      const ticketTypeSelect = document.getElementById('ticket-type');
      ticketTypeSelect.addEventListener("change", updatePrice);

      const peopleInput = document.getElementById('people');
      peopleInput.addEventListener("input", updatePrice);

      function updatePrice() {
        const ticketType = document.getElementById('ticket-type');
        const ticketTypeId = ticketType.selectedOptions[0].id;
        const people = peopleInput.value;

        if (ticketType.value && people > 0) {
          const selectedTicketType = ticketTypesData.find(t => t._id === ticketTypeId);
          const price = selectedTicketType.basePrice * people;
          document.getElementById('price').textContent = `Price: $${price}`;
        } else {
          document.getElementById('price').textContent = '';
        }
      }
    };
  </script>
</head>

<body>
  <h2>New Reservation</h2>
  <form id="newReservationForm">
    <label for="ticket-type">Select Your Ticket Type:</label>
    <br />
    <select id="ticket-type" required>
      <option value="">Select a place</option>
    </select>
    <br />
    <label for="date">Date:</label>
    <br />
    <input type="date" id="date" required>
    <br />
    <label for="people">Number of People:</label>
    <br />
    <input type="number" id="people" required min="1" max="10">
    <br />
    <p id="price"></p>
    <h3>Enter Your Card Information</h3>
    <label for="card-number">Credit Card Number:</label>
    <br />
    <input type="text" id="card-number" required maxlength="16">
    <br />
    <label for="expiry-month">Expiry Month:</label>
    <br />
    <input type="number" id="expiry-month" required min="1" max="12">
    <br />
    <label for="expiry-year">Expiry Year:</label>
    <br />
    <input type="number" id="expiry-year" required>
    <br />
    <label for="security-code">Security Code:</label>
    <br />
    <input type="text" id="security-code" required maxlength="3">
    <br />
    <input type="submit" value="Submit">
  </form>

</body>

</html>