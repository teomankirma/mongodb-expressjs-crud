<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Reservation</title>
  <style>
    .hidden {
      display: none;
    }
  </style>
  <script>
    let ticketTypesData = [];

    window.onload = function () {
      // Set the min attribute of the date input field to the current date
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth() + 1;

      document.getElementById('date').setAttribute('min', today.toISOString().split('T')[0]);


      document.getElementById("expiry-year").setAttribute("min", currentYear)

      const expiryYearInput = document.getElementById("expiry-year");
      const expiryMonthInput = document.getElementById("expiry-month");

      expiryYearInput.addEventListener("change", validateExpiryDate);
      expiryMonthInput.addEventListener("change", validateExpiryDate);

      function validateExpiryDate() {
        if (parseInt(expiryYearInput.value, 10) === currentYear) {
          expiryMonthInput.setAttribute("min", currentMonth);
        }
      }


      const user = JSON.parse(localStorage.getItem('user'));

      if (!user)
        window.location.href = "/signin"; // Redirect to signin page if user doesn't exists

      // Get the select element
      const select = document.getElementById('ticket-type');

      // Fetch ticket types from the server
      fetch('/ticket-types')
        .then(response => response.json())
        .then(ticketTypes => {
          ticketTypesData = ticketTypes;

          // For each ticket type
          ticketTypes.forEach(ticketType => {
            // Create a new option element
            const option = document.createElement('option');

            option.id = ticketType._id;
            option.value = ticketType.type;
            option.textContent = ticketType.type;

            select.appendChild(option);
          });
        })
        .catch(error => console.error('Error:', error));

      // Get the form element
      const form = document.getElementById('newReservationForm');

      // Add an event listener to the form
      form.addEventListener('submit', function (event) {
        // Prevent the default form submission behavior
        event.preventDefault();

        // Get the form data
        const ticketType = document.getElementById('ticket-type').value;
        const date = document.getElementById('date').value;
        const people = document.getElementById('people').value;
        const priceText = document.getElementById('price').textContent;
        const price = priceText ? parseFloat(priceText.replace('Total Price: $', '')) : 0;

        // Create the request body
        const body = {
          userId: user._id,
          ticketType,
          date,
          people,
          price
        };

        // Send a POST request to the server
        fetch('/new-reservation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(body),
        })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              alert(data.error);
            } else {

              console.log(body)

              // Update the user object in localStorage
              user.reservations.push({ ticketType, date, people, price, _id: data._id });
              localStorage.setItem('user', JSON.stringify(user));

              alert('Reservation added successfully');
              window.location.href = '/dashboard'; // Redirect to dashboard page
            }
          })
          .catch((error) => {
            console.error('Error:', error);
          });
      });

      const ticketTypeSelect = document.getElementById('ticket-type');
      ticketTypeSelect.addEventListener("change", updatePrice);

      ticketTypeSelect.addEventListener("change", function () {
        const selectedTicketType = ticketTypesData.find(t => t._id === ticketTypeSelect.selectedOptions[0].id);
        document.getElementById('ticket-type-description').textContent = selectedTicketType.description;
        document.getElementById('single-ticket-price').textContent = `(A single ticket price is $${selectedTicketType.basePrice}.)`;
      });

      const peopleInput = document.getElementById('people');
      peopleInput.addEventListener("input", updatePrice);

      function updatePrice() {
        const ticketType = document.getElementById('ticket-type');
        const ticketTypeId = ticketType.selectedOptions[0].id;
        const people = peopleInput.value;

        if (ticketType.value && people > 0) {
          const selectedTicketType = ticketTypesData.find(t => t._id === ticketTypeId);
          const price = selectedTicketType.basePrice * people;
          document.getElementById('price').textContent = `Total Price: $${price}`;
        } else {
          document.getElementById('price').textContent = '';
        }
      }

      const goToPaymentButton = document.querySelector('#go-to-payment');
      const reservationInfo = document.querySelector('.reservation-info');
      const paymentInfo = document.querySelector('.payment-info');

      goToPaymentButton.addEventListener('click', function (e) {
        e.preventDefault();
        const fields = reservationInfo.querySelectorAll('input, select');

        // Check if all fields are valid
        let allFieldsValid = true;
        for (let i = 0; i < fields.length; i++) {
          if (!fields[i].checkValidity()) {
            allFieldsValid = false;
            break;
          }
        }

        // If all fields are valid, add and remove the classes
        if (allFieldsValid) {
          reservationInfo.classList.add('hidden');
          paymentInfo.classList.remove('hidden');
        } else {
          alert('Please fill out all fields correctly.');
        }
      });

      const goBackButton = document.querySelector('#go-back');

      goBackButton.addEventListener('click', function (e) {
        e.preventDefault();
        reservationInfo.classList.remove('hidden');
        paymentInfo.classList.add('hidden');
      });
    };

  </script>
</head>

<body>
  <form id="newReservationForm">
    <div class="reservation-info">
      <h2>New Reservation</h2>
      <label for="ticket-type">Select Your Ticket Type:</label>
      <br />
      <select id="ticket-type" required>
        <option value="">Select a place</option>
      </select>
      <br />
      <p id="ticket-type-description"></p>
      <p id="single-ticket-price"></p>
      <label for="date">Date:</label>
      <br />
      <input type="date" id="date" required>
      <br />
      <label for="people">Number of People:</label>
      <br />
      <input type="number" id="people" required min="1" max="10">
      <br />
      <p id="price"></p>
      <button id="go-to-payment">Go To Payment</button>
    </div>
    <div class="payment-info hidden">
      <h3>Enter Your Card Information</h3>
      <label for="card-number">Credit Card Number:</label>
      <br />
      <input type="text" id="card-number" required pattern="\d{16}"
        title="Credit card number must be exactly 16 digits">
      <br />
      <label for="expiry-month">Expiry Month:</label>
      <br />
      <input type="number" id="expiry-month" required min="1" max="12">
      <br />
      <label for="expiry-year">Expiry Year:</label>
      <br />
      <input type="number" id="expiry-year" required>
      <br />
      <label for="security-code">Security Code:</label>
      <br />
      <input type="text" id="security-code" required pattern="\d{3}" title="Security code must be exactly 3 digits">
      <br />
      <button id="go-back">Go Back</button>
      <input type="submit" value="Submit">
    </div>
  </form>

</body>

</html>